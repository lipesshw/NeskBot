<%- include('header'); -%>
<html lang="pt-br">
    <head>
        <!--Meta Tags-->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <link rel="stylesheet" href="/index.css">
        <link rel="stylesheet" href="/styles.css">
        <link rel="stylesheet" href="/card.css">
        <title>Ouvindo em: <%= guild.name %></title>    
       

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
        
        <script>(function(a,b){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))window.location=b})(navigator.userAgent||navigator.vendor||window.opera,'http://web.neskapp.live/dashboard');
        </script>

        <%
        const nFormatter = function(num, digits = 2) {
            const lookup = [
                { value: 1, symbol: "" },
                { value: 1e3, symbol: "k" },
                { value: 1e6, symbol: "M" },
                { value: 1e9, symbol: "G" },
                { value: 1e12, symbol: "T" },
                { value: 1e15, symbol: "P" },
                { value: 1e18, symbol: "E" }
            ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            var item = lookup.slice().reverse().find(function(item) {
                return num >= item.value;
            });
            return item ? (num / item.value).toFixed(digits).replace(rx, "$1") + item.symbol : "0";
        } 
        %>
        

        <style>
        .vc{
        background: red;
        }

        .baq{
        background: rgb(15,15,15);
        }
        </style>
    </head>
    <body style="background-color: #131314;
    width: 100%;
    height: 100%;">
    <section id="queue">
        <br><br>
            <%  if(botClient.distube.getQueue(guild.id) && botClient.distube.getQueue(guild.id).songs && botClient.distube.getQueue(guild.id).songs.length > 0){ let current = botClient.distube.getQueue(guild.id).songs[0] %>
                <!-- CURRENT SONG CARD-->
                <center>
                    <h1 style="font-size: 20px;color:#ffffff"><i class="iconify" data-icon="dashicons:format-audio"></i> Tocando atualmente em <%= guild.name %></h1>
                </center>
                
                <div style="display: flex; flex-wrap: wrap; justify-content: center;" style="height: 20px">
                    <!-- CURRENT SONG-->
                    <div class="card2"style="width:750px;height:220px;border: solid 5px rgb(15 15 15); background-color: rgb(15 15 15);border-radius: 7px;">
                        <div id="nowplaying" style="position: relative;width:800px;height:300px;margin-left: 30px;margin-top: 25px;">
                        
                            <img class="img-thumbnail" 
                            style ="width:26%; height: 56%;border-radius: 5px;"
                            src="https://img.youtube.com/vi/<%= current.id %>/mqdefault.jpg" alt="<%= String(current.name).substr(0, 50) %>">
                            <div class="progresswrapper" style="position: absolute; margin-left:28%;width:54%;bottom: 135px;">
                                
                                <div class="progress" style="height:15px;border-radius: 15px;background: #4a4a52;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated vc" 
                                    role="progressbar" 
                                    style="width: <%= Math.floor(botClient.distube.getQueue(guild.id).currentTime) / Math.floor(current.duration) * 100 %>%"
                                    aria-valuenow="<%= Math.floor(botClient.distube.getQueue(guild.id).currentTime) %>"
                                    aria-valuemin="0" 
                                    aria-valuemax="<%= Math.floor(current.duration) %>" > 
                                    </div>
                                </div> 
                                <b style="font-size: 15px"><%= botClient.distube.getQueue(guild.id).formattedCurrentTime %></b><b style="float:right;font-size: 15px;"><%= current.formattedDuration %></b>
                            </div>
                            <h3 style="position: absolute; font-size:17px;margin-left:28%;top: 0px;width:450px;height:10px;"><%= String(current.name).length > 70 ? String(current.name).substr(0, 69) + " ..." : String(current.name) %></h3>
                            <h4 style="font-size: 16px;position: absolute; margin-left:28%;top: 45px;width:440px;height:80px;">
                                <img src="<%= current.user.displayAvatarURL({dynamic: true, size: 4096}) %>" style="width:30px; border-radius: 200px;">
                                <b style="font-size:16px;">Solicitado por:</b> <kdl style="font-size:17px; background-color: #1b1b1b;border: solid 3px #1b1b1b;border-radius: 5px;"><%= current.user.username %><span style="font-size: 15px;color:#65656e;">#<%= current.user.discriminator %></span></kdl>
                            </h4>
                            <h4 style="font-size: 20px;position: absolute; margin-left:44%;top: 81px;width:440px;height:80px;">
                                <img src="https://cdn.discordapp.com/emojis/840260133686870036.png?v=1" style="width:30px">
                                <kdl style="font-size:17px;background-color: #1b1b1b;border: solid 5px #1b1b1b;border-radius: 5px;"><%= nFormatter(current.views, 2) %></kdl>
                            </h4>
                            <h4 style="font-size: 20px;position: absolute; margin-left:28%;top: 81px;width:440px;height:80px;">
                                <img src="https://cdn.discordapp.com/emojis/783353957719998474.gif?v=1" style="width:30px">
                                <kdl style="font-size:17px;background-color: #1b1b1b;border: solid 5px #1b1b1b;border-radius: 5px;font-size:17px"><%= nFormatter(current.likes, 2) %></kdl>
                            </h4>
                            <h4 style="font-size: 20px;position: absolute; margin-left:59%;top: 81px;width:440px;height:80px;">
                                <img src="https://cdn.discordapp.com/emojis/783353914610810881.gif?v=1" style="width:30px">
                                <kdl style="font-size:17px;background-color: #1b1b1b;border: solid 5px #1b1b1b;border-radius: 5px;"><%= nFormatter(current.dislikes, 2) %></kdl>
                        </div>
                    </div>
                    <!-- CONTROLS -->
                    <!--<div style="width:450px;height:350px;border: solid 5px #828cff;border-radius: 15px;margin-left:1%;vertical-align: middle;">
                        <center><h1 style="font-size: 50px;color:#828cff"><i class="iconify" data-icon="il:controls"></i> Controls</h1></center>
                        
                        <button style="font-size: 30px;width: 100%;"
                            class="btn btn-primary" type="button">
                            <i class="iconify" data-icon="dashicons:controls-skipforward" ></i>
                            Skip</button>
                            <button style="font-size: 30px;width: 100%;"
                                class="btn btn-danger" type="button">
                                <i class="iconify" data-icon="fa-solid:stop" ></i>
                                Stop</button>
                            <% if(botClient.distube.getQueue(guild.id).playing){ %>
                            <button style="font-size: 30px;width: 100%;"
                                class="btn btn-primary" type="button">
                                <i class="iconify" data-icon="dashicons:controls-pause" ></i>
                                Pause</button>
                            <% }else{ %>
                            <button style="font-size: 30px;width: 100%;"
                                class="btn btn-success" type="button">
                                <i class="iconify" data-icon="dashicons:controls-play" ></i>
                                Resume</button>
                            <% } %>
                    </div> -->
                </div>
                <br>
                <br>
                <!-- SHOWING THE QUEUE-->
                <center>
                    <h1 style="font-size: 22px;color:#ffffff"><i class="iconify" data-icon="bi:music-note-list"></i> Lista de músicas que irão tocar: <span id="queueamount"> <%= botClient.distube.getQueue(guild.id) && botClient.distube.getQueue(guild.id).songs ? botClient.distube.getQueue(guild.id).songs.length : 0 %> música(s) </span></h1>
                </center>
                <div style="display: flex; flex-wrap: wrap; justify-content: center;" id="wholequeue">
                    <div id="currentsong" class="card mb-3 text-white bg-ifo mb-3 blue" style="background-color: rgb(15,15,15)">
                        <img class="card-img-top" src="https://img.youtube.com/vi/<%= current.id %>/mqdefault.jpg" alt="Card image cap">
                        <div class="card-body">
                            <h5 class="card-title" style="color: #ffffff; font-size:16px "><b style="font-size:16px">0.</b> <a href="<%= current.url %>" style="text-decoration: none;color: #ffffff" target="_blank" style="font-size:16px"><%= current.name %></a></h5>
                            <p class="mt-auto card-text"><small class="text-muted" style="color: #ffffff !important;">Solicitado por: <%= current.user.tag %></small></p>
                            <p class="mt-auto card-text"><small class="text-muted" style="color: #ffffff !important; top:17px;">Duração: <%= botClient.distube.getQueue(guild.id).formattedCurrentTime + " / " + current.formattedDuration %></small></p>                          
                            </div>
                    </div>
                    <% botClient.distube.getQueue(guild.id).songs.forEach((song, i) => { if(i>0){ %>
                        <div class="card mb-3 green baq <%= i==0 ? 'text-white bg-success': 'text-white bg-secondar mb-3' %> ">
                            <img class="card-img-top" src="https://img.youtube.com/vi/<%= song.id %>/mqdefault.jpg" alt="Card image cap">
                            <div class="card-body">
                            <h5 class="card-title" style="color: #ffffff; font-size:16px";<b><%= i + 1%>.</b> <a href="<%= song.url %>" style="text-decoration: none;color: <%= i==0 ? '#ffffff' :'#ffffff' %>" target="_blank"><%= song.name %></a></h5>
                            <p class="mt-auto card-text"><small class="text-muted" style="color: #fff !important;">Solicitado por: <%= song.user.tag %></small></p>
                            <p class="mt-auto card-text"><small class="text-muted" style="color: #fff !important">Duração: <%= song.formattedDuration %></small></p>                          
                            </div>
                        </div>
                    <% }}) %>
                </div>
            <% }else{ %>
                <center>
                    <h3 style="color:FFFFFF;font-size: 22px">Não tem nenhuma música tocando no momento. :(</h3>
                </center>
            <% } %>
    </section>

    <div class="navbar__container">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3299273150352748"
     crossorigin="anonymous"></script>
    </div>
    
    <script src="app.js"></script>

       <!--JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    
    <script type="text/javascript">
        window.onload = startInterval
        function startInterval()
        {
            setInterval(()=>{
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        try{
                            // if it worked, parse that string, make it back into an object
                            var data = this.responseText
                            parser = new DOMParser();
                            var doc = parser.parseFromString(data, "text/html");
                            if(document.getElementById("queueamount").innerHTML != data) {
                                data = doc.querySelector("#wholequeue").innerHTML;
                                document.getElementById("wholequeue").innerHTML = data;
                            } else{
                                data = doc.querySelector("#currentsong").innerHTML;
                                document.getElementById("currentsong").innerHTML = data;
                            }
                            data = doc.querySelector("#queueamount").innerHTML;
                            document.getElementById("queueamount").innerHTML = data;
                            data = doc.querySelector("#nowplaying").innerHTML;
                            document.getElementById("nowplaying").innerHTML = data;
                        }catch (e){
                            data = doc.querySelector("#queue").innerHTML;
                            document.getElementById("queue").innerHTML = data;
                            console.log(e)
                        }
                    }
                };
                xmlhttp.open("GET", "/queue/<%= req.params.guildID %>", true);
                xmlhttp.send();

            }, 1000);
        }
    </script>
  </body>
</html>
